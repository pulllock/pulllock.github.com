<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Java中的ScheduledThreadPoolExecutor</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	=================<br>
	== <a href="http://cxis.me/">Time Stream</a> ==<br>
	=================
	<div style="float: right;">一个小学生</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories"><b>Categories</b></a>.
			
			<a href="/tags"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Java中的ScheduledThreadPoolExecutor</h1>
			<b><time>2016-05-30 17:57:06</time></b>
		       
		           <a href="/tags/java">Java</a>
        	       

			<div>
				<p>ScheduledThreadPoolExecutor使用和原理学习。</p>
<!-- raw HTML omitted -->
<h1 id="原理">原理</h1>
<p>ScheduledThreadPoolExecutor提供了延迟和周期执行功能，内部实现相当于使用DelayQueue延时队列、PriorityQueue优先级队列和Delayed三者来配合实现的功能，在使用延时队列实现我们自己的业务功能时，也会使用这三个组件来配合。但是实际上ScheduledThreadPoolExecutor不是直接使用这三个组件来实现，而是在内部实现了几个功能类似的内部类：</p>
<ul>
<li>DelayedWorkQueue，功能相当于DelayQueue，只不过这个内部没有依赖PriorityQueue，而是直接实现了堆排序功能。</li>
<li>ScheduledFutureTask，相当于实现了Delayed接口的业务类，ScheduledFutureTask的父接口的父接口ScheduledFuture继承了Delayed接口，ScheduledFutureTask实现了getDelay和compareTo方法，这两个方法可以参考DelayQueue解析中的使用。</li>
</ul>
<h1 id="方法">方法</h1>
<ul>
<li>schedule，给定延迟后，执行任务</li>
<li>scheduleAtFixedRate，每个任务都在指定的时间间隔内执行，如果一个任务瞬间执行完，指定的时间间隔还有很多剩余的，下一个任务也不会执行；如果一个任务在指定的时间间隔没有执行完，占用了下个任务的时间，那这个任务执行完后下个任务立马就开始。</li>
<li>scheduleWithFixedDelay，在一次任务结束后，间隔指定的时间，再继续执行下一次任务，不管一次任务执行多长时间，在这次任务结束后都会暂停指定的时间，接下来再执行下面的任务。就是说我不管，我每次任务完成都必须要休息一定时间。</li>
</ul>
<h1 id="源码">源码</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e">     * 给定延迟后，执行任务，只会执行一次
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> ScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> schedule<span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">,</span>
                                       <span style="color:#66d9ef">long</span> delay<span style="color:#f92672">,</span>
                                       TimeUnit unit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>command <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> unit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
        <span style="color:#75715e">// 创建执行的Task实例，由于schedule只执行一次，所以实例化ScheduledFutureTask的时候周期数是0
</span><span style="color:#75715e"></span>        RunnableScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> t <span style="color:#f92672">=</span> decorateTask<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">new</span> ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;(</span>command<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                                          triggerTime<span style="color:#f92672">(</span>delay<span style="color:#f92672">,</span> unit<span style="color:#f92672">)));</span>
        delayedExecute<span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e">     * 每个任务都在指定的时间间隔内执行，如果一个任务瞬间执行完，
</span><span style="color:#75715e">     * 指定的时间间隔还有很多剩余的，下一个任务也不会执行；如果一
</span><span style="color:#75715e">     * 个任务在指定的时间间隔没有执行完，占用了下个任务的时间，
</span><span style="color:#75715e">     * 那这个任务执行完后下个任务立马就开始。
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> ScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> scheduleAtFixedRate<span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">,</span>
                                                  <span style="color:#66d9ef">long</span> initialDelay<span style="color:#f92672">,</span>
                                                  <span style="color:#66d9ef">long</span> period<span style="color:#f92672">,</span>
                                                  TimeUnit unit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>command <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> unit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>period <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">();</span>
        <span style="color:#75715e">// 实例化ScheduledFutureTask的时候周期数为指定的周期数
</span><span style="color:#75715e"></span>        ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> sft <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;(</span>command<span style="color:#f92672">,</span>
                                          <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                                          triggerTime<span style="color:#f92672">(</span>initialDelay<span style="color:#f92672">,</span> unit<span style="color:#f92672">),</span>
                                          unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(</span>period<span style="color:#f92672">));</span>
        RunnableScheduledFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> t <span style="color:#f92672">=</span> decorateTask<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> sft<span style="color:#f92672">);</span>
        sft<span style="color:#f92672">.</span><span style="color:#a6e22e">outerTask</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
        <span style="color:#75715e">// 延迟执行
</span><span style="color:#75715e"></span>        delayedExecute<span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e">     * 在一次任务结束后，间隔指定的时间，再继续执行下一次任务，
</span><span style="color:#75715e">     * 不管一次任务执行多长时间，在这次任务结束后都会暂停指定的
</span><span style="color:#75715e">     * 时间，接下来再执行下面的任务。就是说我不管，我每次任务完成
</span><span style="color:#75715e">     * 都必须要休息一定时间。
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> ScheduledFuture<span style="color:#f92672">&lt;?&gt;</span> scheduleWithFixedDelay<span style="color:#f92672">(</span>Runnable command<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">long</span> initialDelay<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">long</span> delay<span style="color:#f92672">,</span>
                                                     TimeUnit unit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>command <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> unit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delay <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">();</span>
        <span style="color:#75715e">// 实例化ScheduledFutureTask的时候周期数是指定的延时时长，并且是负数
</span><span style="color:#75715e"></span>        ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> sft <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ScheduledFutureTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;(</span>command<span style="color:#f92672">,</span>
                                          <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                                          triggerTime<span style="color:#f92672">(</span>initialDelay<span style="color:#f92672">,</span> unit<span style="color:#f92672">),</span>
                                          unit<span style="color:#f92672">.</span><span style="color:#a6e22e">toNanos</span><span style="color:#f92672">(-</span>delay<span style="color:#f92672">));</span>
        RunnableScheduledFuture<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> t <span style="color:#f92672">=</span> decorateTask<span style="color:#f92672">(</span>command<span style="color:#f92672">,</span> sft<span style="color:#f92672">);</span>
        sft<span style="color:#f92672">.</span><span style="color:#a6e22e">outerTask</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
        <span style="color:#75715e">// 延迟执行
</span><span style="color:#75715e"></span>        delayedExecute<span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ScheduledFutureTask是实现了Delayed接口的类，重写的getDelay和compareTo方法跟我们自己实现业务逻辑一样。</p>
<p>run方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 是否是周期任务
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> periodic <span style="color:#f92672">=</span> isPeriodic<span style="color:#f92672">();</span>
            <span style="color:#75715e">// 判断当前线程状态是否能执行任务
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>canRunInCurrentRunState<span style="color:#f92672">(</span>periodic<span style="color:#f92672">))</span>
                cancel<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// 不是周期性任务，直接执行
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>periodic<span style="color:#f92672">)</span>
                ScheduledFutureTask<span style="color:#f92672">.</span><span style="color:#a6e22e">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// 周期性任务，执行任务，设置下次执行时间
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ScheduledFutureTask<span style="color:#f92672">.</span><span style="color:#a6e22e">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">runAndReset</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 设置下次执行时间
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// scheduleAtFixedRate和scheduleWithFixedDelay的period不同，处理也不一样
</span><span style="color:#75715e"></span>                setNextRunTime<span style="color:#f92672">();</span>
                <span style="color:#75715e">// 将下次要执行的任务添加到队列中
</span><span style="color:#75715e"></span>                reExecutePeriodic<span style="color:#f92672">(</span>outerTask<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setNextRunTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// scheduleAtFixedRate的period是大于0的
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// scheduleWithFixedDelay是小于0的
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> p <span style="color:#f92672">=</span> period<span style="color:#f92672">;</span>
            <span style="color:#75715e">//scheduleAtFixedRate，下次时间执行的时间等于上次开始执行时间加上周期时间
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span>
                time <span style="color:#f92672">+=</span> p<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span>
                <span style="color:#75715e">// 下次执行时间等于当前时间加上周期时间，也就是要暂停period时间
</span><span style="color:#75715e"></span>                time <span style="color:#f92672">=</span> triggerTime<span style="color:#f92672">(-</span>p<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
</code></pre></div>
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/2020/11/02/mybatis%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E4%BB%8B%E7%BB%8D/">MyBatis启动过程介绍</a></li>
				
				<li><a href="/2020/10/26/springboot%E4%B8%AD%E6%89%A9%E5%B1%95%E7%82%B9%E6%B1%87%E6%80%BB/">SpringBoot中扩展点汇总</a></li>
				
				<li><a href="/2020/08/26/spring%E4%B8%AD%E5%AF%B9groovy%E6%94%AF%E6%8C%81%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Spring中对Groovy支持的源码分析</a></li>
				
				<li><a href="/2020/08/25/spring%E4%B8%AD%E4%BD%BF%E7%94%A8groovy%E7%9A%84%E7%A4%BA%E4%BE%8B/">Spring中使用Groovy的示例</a></li>
				
				<li><a href="/2020/05/05/spring%E4%B8%ADplaceholder%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B/">Spring中Placeholder的解析过程</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2021 <a href="http://cxis.me/"><b>cxis</b></a>.
	<a href="https://gohugo.io/"><b>Hugo</b></a>.
	<a href="https://github.com/colorchestra/smol"><b>Smol</b></a>.
	<a href="https://github.com/dachengxi"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
